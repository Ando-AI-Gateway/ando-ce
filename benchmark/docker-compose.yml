# ============================================================
# Ando vs APISIX Benchmark — Docker Compose
# ============================================================
# Usage: ./benchmark/bench.sh
# Requires: docker (with compose plugin)
# ============================================================

services:

  # ── Echo backend — raw upstream (no proxy) ──────────────────
  echo:
    build:
      context: ..
      dockerfile: benchmark/Dockerfile.echo
    networks: [bench]
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/ > /dev/null 2>&1"]
      interval: 2s
      timeout: 2s
      retries: 20
      start_period: 5s

  # ── Ando API Gateway ────────────────────────────────────────
  ando:
    build:
      context: ..
      dockerfile: deploy/docker/Dockerfile
    volumes:
      - ./ando-bench.yaml:/etc/ando/ando.yaml:ro
    networks: [bench]
    depends_on:
      echo:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:9180/apisix/admin/health"]
      interval: 3s
      timeout: 3s
      retries: 20
      start_period: 10s

  # ── etcd — APISIX config store ──────────────────────────────
  etcd:
    image: quay.io/coreos/etcd:v3.5.0
    command:
      - /usr/local/bin/etcd
      - --data-dir=/etcd-data
      - --listen-client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://etcd:2379
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-advertise-peer-urls=http://etcd:2380
      - --initial-cluster=default=http://etcd:2380
    environment:
      ETCDCTL_API: "3"
    networks: [bench]
    healthcheck:
      test: ["CMD-SHELL", "ETCDCTL_API=3 etcdctl --endpoints=http://localhost:2379 endpoint health"]
      interval: 3s
      timeout: 3s
      retries: 15
      start_period: 5s

  # ── APISIX API Gateway (comparison target) ──────────────────
  apisix:
    image: apache/apisix:3.15.0-debian
    volumes:
      - ./apisix-config.yaml:/usr/local/apisix/conf/config.yaml:ro
    networks: [bench]
    depends_on:
      etcd:
        condition: service_healthy
      echo:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/9180' 2>/dev/null || bash -c 'echo > /dev/tcp/localhost/8080' 2>/dev/null"]
      interval: 2s
      timeout: 5s
      retries: 40
      start_period: 15s

networks:
  bench:
    name: bench_net
