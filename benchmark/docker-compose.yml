# ============================================================
# Ando v1 vs Ando v2 vs APISIX vs KrakenD vs Kong vs Tyk
# Unified Benchmark
# ============================================================
# Usage: ./benchmark/bench.sh [baseline|plain|auth|stress|ramp|all]
#
# Env overrides:
#   BENCH_DURATION=60s BENCH_CONNECTIONS=400 ./benchmark/bench.sh
#
# Requires: docker (with compose plugin)
# ============================================================

services:

  # ── Echo backend — raw upstream (no proxy) ──────────────────
  echo:
    build:
      context: ..
      dockerfile: benchmark/Dockerfile.echo
    networks: [bench]
    sysctls:
      - net.core.somaxconn=32768
      - net.ipv4.tcp_max_syn_backlog=32768
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/ > /dev/null 2>&1"]
      interval: 2s
      timeout: 2s
      retries: 20
      start_period: 5s

  # ── Ando v1 (Pingora / Tokio) ───────────────────────────────
  ando-v1:
    build:
      context: ../v1
      dockerfile: deploy/docker/Dockerfile
    volumes:
      - ./ando-v1-bench.yaml:/etc/ando/ando.yaml:ro
    networks: [bench]
    depends_on:
      echo:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9180/apisix/admin/health || exit 1"]
      interval: 3s
      timeout: 3s
      retries: 20
      start_period: 15s

  # ── Ando v2 (monoio / thread-per-core) ──────────────────────
  ando-v2:
    build:
      context: ../v2
      dockerfile: Dockerfile
    volumes:
      - ./ando-v2-bench.yaml:/etc/ando/ando.yaml:ro
    networks: [bench]
    depends_on:
      echo:
        condition: service_healthy
    sysctls:
      - net.core.somaxconn=32768
      - net.ipv4.tcp_max_syn_backlog=32768
      - net.ipv4.ip_local_port_range=1024 65535
      - net.ipv4.tcp_tw_reuse=1
      - net.ipv4.tcp_fin_timeout=10
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9180/apisix/admin/health || exit 1"]
      interval: 3s
      timeout: 3s
      retries: 20
      start_period: 15s

  # ── etcd — APISIX config store ──────────────────────────────
  etcd:
    image: quay.io/coreos/etcd:v3.5.0
    command:
      - /usr/local/bin/etcd
      - --data-dir=/etcd-data
      - --listen-client-urls=http://0.0.0.0:2379
      - --advertise-client-urls=http://etcd:2379
      - --listen-peer-urls=http://0.0.0.0:2380
      - --initial-advertise-peer-urls=http://etcd:2380
      - --initial-cluster=default=http://etcd:2380
    environment:
      ETCDCTL_API: "3"
    networks: [bench]
    healthcheck:
      test: ["CMD-SHELL", "ETCDCTL_API=3 etcdctl --endpoints=http://localhost:2379 endpoint health"]
      interval: 3s
      timeout: 3s
      retries: 15
      start_period: 5s

  # ── APISIX (comparison target) ──────────────────────────────
  apisix:
    image: apache/apisix:3.15.0-debian
    volumes:
      - ./apisix-config.yaml:/usr/local/apisix/conf/config.yaml:ro
    networks: [bench]
    depends_on:
      etcd:
        condition: service_healthy
      echo:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "bash -c 'echo > /dev/tcp/localhost/9180' 2>/dev/null || bash -c 'echo > /dev/tcp/localhost/8080' 2>/dev/null"]
      interval: 2s
      timeout: 5s
      retries: 40
      start_period: 15s

  # ── Redis — Tyk session store ───────────────────────────────
  redis:
    image: redis:7-alpine
    networks: [bench]
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 2s
      timeout: 2s
      retries: 15
      start_period: 5s

  # ── KrakenD (config-file based, no DB) ──────────────────────
  krakend:
    image: devopsfaith/krakend:2.7
    command: run -c /etc/krakend/krakend.json
    volumes:
      - ./krakend.json:/etc/krakend/krakend.json:ro
    networks: [bench]
    depends_on:
      echo:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/__health > /dev/null 2>&1"]
      interval: 3s
      timeout: 3s
      retries: 20
      start_period: 10s

  # ── Kong (DB-less, declarative config) ──────────────────────
  kong:
    image: kong:3.9
    environment:
      KONG_DATABASE: "off"
      KONG_DECLARATIVE_CONFIG: /kong.yml
      KONG_PROXY_LISTEN: "0.0.0.0:8000"
      KONG_ADMIN_LISTEN: "0.0.0.0:8001"
      KONG_LOG_LEVEL: warn
    volumes:
      - ./kong.yml:/kong.yml:ro
    networks: [bench]
    depends_on:
      echo:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "kong health"]
      interval: 3s
      timeout: 5s
      retries: 30
      start_period: 15s

  # ── Tyk Gateway (OSS) ───────────────────────────────────────
  tyk:
    image: tykio/tyk-gateway:v5.3
    volumes:
      - ./tyk/tyk.conf:/opt/tyk-gateway/tyk.conf:ro
      - ./tyk/apps:/opt/tyk-gateway/apps:ro
      - ./tyk/policies:/opt/tyk-gateway/policies:ro
    networks: [bench]
    depends_on:
      redis:
        condition: service_healthy
      echo:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:8080/hello || exit 1"]
      interval: 3s
      timeout: 3s
      retries: 30
      start_period: 15s

networks:
  bench:
    name: bench_net
