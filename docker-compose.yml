# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#  Ando CE — Production Docker Compose
# ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
#
# Usage:
#   docker compose up -d          # Start all services
#   docker compose up -d ando     # Start gateway only (standalone)
#   docker compose logs -f ando   # Follow logs
#   docker compose down           # Stop all
#
# Modes:
#   standalone (default): ando only, routes via admin API
#   etcd:                 ando + etcd, dynamic config with watch
#
# Ports:
#   9080  — HTTP proxy (data plane)
#   9443  — HTTPS proxy (reserved)
#   9180  — Admin API (control plane)

services:

  # ── Ando CE Gateway ──────────────────────────────────────────
  ando:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: ando-gateway
    restart: unless-stopped
    ports:
      - "${ANDO_PROXY_PORT:-9080}:9080"
      - "${ANDO_ADMIN_PORT:-9180}:9180"
    volumes:
      - ./config/ando.yaml:/etc/ando/ando.yaml:ro
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      # Override any config via ANDO_ env prefix:
      # - ANDO_PROXY_WORKERS=4
      # - ANDO_PROXY_HTTP_ADDR=0.0.0.0:9080
      # - ANDO_ADMIN_ENABLED=true
    networks:
      - ando-net
    sysctls:
      - net.core.somaxconn=32768
      - net.ipv4.tcp_max_syn_backlog=32768
      - net.ipv4.ip_local_port_range=1024 65535
      - net.ipv4.tcp_tw_reuse=1
      - net.ipv4.tcp_fin_timeout=10
    ulimits:
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:9180/apisix/admin/health || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 128M

  # ── etcd (optional — for dynamic config mode) ───────────────
  # Uncomment to enable etcd-backed configuration with hot reload.
  # Also update config/ando.yaml: deployment.mode: etcd
  #
  # etcd:
  #   image: quay.io/coreos/etcd:v3.5.0
  #   container_name: ando-etcd
  #   restart: unless-stopped
  #   command:
  #     - /usr/local/bin/etcd
  #     - --data-dir=/etcd-data
  #     - --listen-client-urls=http://0.0.0.0:2379
  #     - --advertise-client-urls=http://etcd:2379
  #     - --listen-peer-urls=http://0.0.0.0:2380
  #     - --initial-advertise-peer-urls=http://etcd:2380
  #     - --initial-cluster=default=http://etcd:2380
  #   environment:
  #     ETCDCTL_API: "3"
  #   volumes:
  #     - etcd-data:/etcd-data
  #   networks:
  #     - ando-net
  #   healthcheck:
  #     test: ["CMD-SHELL", "ETCDCTL_API=3 etcdctl --endpoints=http://localhost:2379 endpoint health"]
  #     interval: 5s
  #     timeout: 3s
  #     retries: 10
  #     start_period: 5s

networks:
  ando-net:
    name: ando-net
    driver: bridge

# volumes:
#   etcd-data:
